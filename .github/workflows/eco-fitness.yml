name: Eco-Fitness Monitoring

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  eco-fitness-audit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for accurate metrics

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Eco-Fitness Audit
        id: audit
        run: |
          # Calculate metrics
          CONTRIBUTORS=$(git log --all --format='%aN' | sort -u | wc -l)
          COMMITS_6MO=$(git log --since="6 months ago" --oneline | wc -l)
          COMMITS_PER_DAY=$(echo "scale=2; $COMMITS_6MO / 180" | bc)

          # Shannon diversity
          SHANNON=$(git log --all --format='%aN' | sort | uniq -c | awk '
          {
            count[NR] = $1
            total += $1
          }
          END {
            H = 0
            for (i in count) {
              p = count[i] / total
              if (p > 0) {
                H -= p * log(p)
              }
            }
            printf "%.2f", H
          }')

          # Security score
          VULNS=$(npm audit --json 2>/dev/null | jq -r '.metadata.vulnerabilities.total' || echo 0)
          SECURITY_SCORE=10
          if [ "$VULNS" -gt 0 ]; then
            SECURITY_SCORE=$(echo "10 - ($VULNS * 0.5)" | bc)
          fi

          # Bus factor (simplified)
          TOP_CONTRIBUTOR_PCT=$(git log --all --format='%aN' | sort | uniq -c | sort -rn | head -1 | awk -v total=$(git log --all --oneline | wc -l) '{printf "%.0f", ($1/total)*100}')
          if [ "$TOP_CONTRIBUTOR_PCT" -gt 50 ]; then
            BUS_FACTOR=1
          elif [ "$TOP_CONTRIBUTOR_PCT" -gt 30 ]; then
            BUS_FACTOR=2
          else
            BUS_FACTOR=3
          fi

          # Calculate composite score
          VISIBILITY=5  # Baseline for new repos
          METABOLIC=$(echo "scale=2; ($COMMITS_PER_DAY / 3.0) * 25" | bc | awk '{if($1>25) print 25; else print $1}')
          RESILIENCE=$(echo "scale=2; ($SECURITY_SCORE / 10) * 30" | bc)
          BIODIVERSITY=$(echo "scale=2; ($CONTRIBUTORS / 10) * 10" | bc | awk '{if($1>10) print 10; else print $1}')
          DIVERSITY=$(echo "scale=2; ($SHANNON / 2.0) * 10" | bc | awk '{if($1>10) print 10; else print $1}')
          SUCCESSION=10

          TOTAL=$(echo "$VISIBILITY + $METABOLIC + $RESILIENCE + $BIODIVERSITY + $DIVERSITY + $SUCCESSION" | bc)

          # Classification
          if (( $(echo "$TOTAL >= 90" | bc -l) )); then
            CLASS="Climax-Ecosystem"
            COLOR="brightgreen"
          elif (( $(echo "$TOTAL >= 75" | bc -l) )); then
            CLASS="Thriving-Pioneer"
            COLOR="green"
          elif (( $(echo "$TOTAL >= 60" | bc -l) )); then
            CLASS="Active-Pioneer"
            COLOR="yellowgreen"
          else
            CLASS="At-Risk"
            COLOR="orange"
          fi

          # Output for badge
          echo "score=$TOTAL" >> $GITHUB_OUTPUT
          echo "class=$CLASS" >> $GITHUB_OUTPUT
          echo "color=$COLOR" >> $GITHUB_OUTPUT
          echo "contributors=$CONTRIBUTORS" >> $GITHUB_OUTPUT
          echo "shannon=$SHANNON" >> $GITHUB_OUTPUT
          echo "bus_factor=$BUS_FACTOR" >> $GITHUB_OUTPUT
          echo "vulnerabilities=$VULNS" >> $GITHUB_OUTPUT

          # Create metrics file
          cat > eco-fitness-report.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "score": $TOTAL,
            "classification": "$CLASS",
            "metrics": {
              "contributors": $CONTRIBUTORS,
              "shannon_diversity": $SHANNON,
              "bus_factor": $BUS_FACTOR,
              "commits_per_day": $COMMITS_PER_DAY,
              "vulnerabilities": $VULNS,
              "security_score": $SECURITY_SCORE
            },
            "factors": {
              "visibility": $VISIBILITY,
              "metabolic_rate": $METABOLIC,
              "predator_resilience": $RESILIENCE,
              "biodiversity": $(echo "$BIODIVERSITY + $DIVERSITY" | bc),
              "succession_stage": $SUCCESSION
            }
          }
          EOF

      - name: Create eco-fitness badge
        run: |
          SCORE=${{ steps.audit.outputs.score }}
          CLASS=${{ steps.audit.outputs.class }}
          COLOR=${{ steps.audit.outputs.color }}

          # Update badge in README if it exists
          echo "Eco-Fitness: $SCORE/100 ($CLASS)"

      - name: Post summary
        run: |
          echo "## üåø Eco-Fitness Audit Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Score:** ${{ steps.audit.outputs.score }}/100" >> $GITHUB_STEP_SUMMARY
          echo "**Classification:** ${{ steps.audit.outputs.class }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Key Metrics" >> $GITHUB_STEP_SUMMARY
          echo "- Contributors: ${{ steps.audit.outputs.contributors }}" >> $GITHUB_STEP_SUMMARY
          echo "- Shannon Diversity: ${{ steps.audit.outputs.shannon }}" >> $GITHUB_STEP_SUMMARY
          echo "- Bus Factor: ${{ steps.audit.outputs.bus_factor }}" >> $GITHUB_STEP_SUMMARY
          echo "- Vulnerabilities: ${{ steps.audit.outputs.vulnerabilities }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.audit.outputs.bus_factor }}" -lt 3 ]; then
            echo "‚ö†Ô∏è **CRITICAL:** Bus factor < 3 - ecosystem at risk!" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload eco-fitness report
        uses: actions/upload-artifact@v4
        with:
          name: eco-fitness-report
          path: eco-fitness-report.json
          retention-days: 90

      - name: Commit updated metrics (main branch only)
        if: github.ref == 'refs/heads/main'
        run: |
          git config --local user.email "eco-fitness-bot@kullailabs.dev"
          git config --local user.name "Eco-Fitness Monitor"

          mkdir -p .github/metrics
          mv eco-fitness-report.json .github/metrics/latest.json

          if git diff --quiet .github/metrics/latest.json; then
            echo "No changes to commit"
          else
            git add .github/metrics/latest.json
            git commit -m "üìä Update eco-fitness metrics [skip ci]"
            git push
          fi
